<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Мастер по металлу - Двери, заборы, кованые изделия</title>

  <!-- Стили -->
  <style id="inline-css">
/* Основные стили */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    /* Темная тема (по умолчанию) */
    --bg-primary: #2c3e50;
    --bg-secondary: #34495e;
    --bg-tertiary: #2c3e50;
    --text-primary: #ecf0f1;
    --text-secondary: #bdc3c7;
    --accent-color: #e74c3c;
    --accent-hover: #c0392b;
    --border-color: #34495e;
    --card-bg: #2c3e50;
    --input-bg: #2c3e50;
    --shadow: rgba(0,0,0,0.3);
}

[data-theme="light"] {
    /* Светлая тема */
    --bg-primary: #f8f9fa;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e9ecef;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --accent-color: #dc3545;
    --accent-hover: #c82333;
    --border-color: #dee2e6;
    --card-bg: #ffffff;
    --input-bg: #ffffff;
    --shadow: rgba(0,0,0,0.1);
}

body {
    font-family: 'Roboto', sans-serif;
    line-height: 1.6;
    color: var(--text-primary);
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    overflow-x: hidden;
    transition: all 0.3s ease;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

/* Навигация */
.navbar {
    position: fixed;
    top: 0;
    width: 100%;
    background: rgba(44, 62, 80, 0.95);
    backdrop-filter: blur(10px);
    z-index: 1000;
    transition: all 0.3s ease;
    border-bottom: 2px solid var(--accent-color);
}

[data-theme="light"] .navbar {
    background: rgba(248, 249, 250, 0.95);
}

.nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 70px;
}

.nav-logo {
    display: flex;
    align-items: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: #e74c3c;
    text-decoration: none;
}

.nav-logo i {
    margin-right: 10px;
    font-size: 1.8rem;
    animation: hammer 2s infinite;
}

@keyframes hammer {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-10deg); }
    75% { transform: rotate(10deg); }
}

.nav-menu {
    display: flex;
    list-style: none;
    gap: 30px;
}

.nav-link {
    color: #ecf0f1;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
    padding: 10px 0;
}

.nav-link:hover {
    color: #e74c3c;
    transform: translateY(-2px);
}

.nav-link::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: #e74c3c;
    transition: width 0.3s ease;
}

.nav-link:hover::after {
    width: 100%;
}

/* Переключатель тем */
.theme-toggle {
    background: transparent;
    border: 2px solid var(--accent-color);
    color: var(--text-primary);
    padding: 8px 12px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.theme-toggle:hover {
    background: var(--accent-color);
    color: white;
    transform: scale(1.1);
}

.theme-toggle i {
    transition: transform 0.3s ease;
}

[data-theme="light"] .theme-toggle i {
    transform: rotate(180deg);
}

/* Дополнительные стили для светлой темы */
[data-theme="light"] .hero {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
}

[data-theme="light"] .hero-title {
    color: #212529;
    text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
}

[data-theme="light"] .hero-subtitle {
    color: #6c757d;
}

[data-theme="light"] .section-title {
    color: #212529;
}

[data-theme="light"] .product-title {
    color: #212529;
}

[data-theme="light"] .product-description {
    color: #6c757d;
}

[data-theme="light"] .contact-item {
    background: #ffffff;
    border: 1px solid #dee2e6;
}

[data-theme="light"] .contact-item:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

[data-theme="light"] .contact-form {
    background: #ffffff;
    border: 1px solid #dee2e6;
}

[data-theme="light"] .contact-form h3 {
    color: #212529;
}

[data-theme="light"] .contact-form input,
[data-theme="light"] .contact-form textarea {
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    color: #212529;
}

[data-theme="light"] .contact-form input:focus,
[data-theme="light"] .contact-form textarea:focus {
    border-color: #dc3545;
}

[data-theme="light"] .footer {
    background: #212529;
    border-top: 2px solid #dc3545;
}

[data-theme="light"] .footer p {
    color: #ffffff;
}

[data-theme="light"] .modal {
    background-color: rgba(0,0,0,0.5);
}

[data-theme="light"] .close {
    color: #212529;
}

[data-theme="light"] .close:hover {
    color: #dc3545;
}

[data-theme="light"] .modal-info h2 {
    color: #212529;
}

[data-theme="light"] .modal-description {
    color: #6c757d;
}

[data-theme="light"] .profile-details h3 {
    color: #212529;
}

[data-theme="light"] .profile-details p {
    color: #6c757d;
}

[data-theme="light"] .admin-header h3 {
    color: #212529;
}

[data-theme="light"] .order-item {
    background: #ffffff;
    border-left: 4px solid #dc3545;
    border: 1px solid #dee2e6;
}

[data-theme="light"] .order-details {
    color: #6c757d;
}

[data-theme="light"] .user-item {
    background: #ffffff;
    border: 1px solid #dee2e6;
}

[data-theme="light"] .user-details h4 {
    color: #212529;
}

[data-theme="light"] .user-details p {
    color: #6c757d;
}

.hamburger {
    display: none;
    flex-direction: column;
    cursor: pointer;
}

.hamburger span {
    width: 25px;
    height: 3px;
    background: #ecf0f1;
    margin: 3px 0;
    transition: 0.3s;
}

/* Главная секция */
.hero {
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    position: relative;
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
    overflow: hidden;
}

.hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23e74c3c" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    animation: float 20s infinite linear;
}

@keyframes float {
    0% { transform: translateX(-100px); }
    100% { transform: translateX(100px); }
}

.hero-content {
    position: relative;
    z-index: 2;
    max-width: 800px;
    padding: 0 20px;
}

.hero-title {
    font-size: 4rem;
    font-weight: 700;
    color: #ecf0f1;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    animation: slideInDown 1s ease-out;
}

.hero-subtitle {
    font-size: 1.5rem;
    color: #bdc3c7;
    margin-bottom: 40px;
    animation: slideInUp 1s ease-out 0.3s both;
}

.hero-buttons {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
    animation: slideInUp 1s ease-out 0.6s both;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Кнопки */
.btn {
    display: inline-block;
    padding: 15px 30px;
    text-decoration: none;
    border-radius: 5px;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn-primary {
    background: linear-gradient(45deg, var(--accent-color), var(--accent-hover));
    color: white;
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}

.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
}

.btn-secondary {
    background: transparent;
    color: var(--text-primary);
    border: 2px solid var(--accent-color);
}

.btn-secondary:hover {
    background: var(--accent-color);
    transform: translateY(-3px);
}

/* Анимация искр */
.hero-animation {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.spark {
    position: absolute;
    width: 4px;
    height: 4px;
    background: #e74c3c;
    border-radius: 50%;
    animation: sparkle 3s infinite;
}

.spark-1 {
    top: 20%;
    left: 20%;
    animation-delay: 0s;
}

.spark-2 {
    top: 60%;
    right: 30%;
    animation-delay: 1s;
}

.spark-3 {
    bottom: 30%;
    left: 60%;
    animation-delay: 2s;
}

@keyframes sparkle {
    0%, 100% {
        opacity: 0;
        transform: scale(0);
    }
    50% {
        opacity: 1;
        transform: scale(1);
    }
}

/* Секции */
.section-title {
    text-align: center;
    font-size: 2.5rem;
    color: #ecf0f1;
    margin-bottom: 50px;
    position: relative;
}

.section-title::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 3px;
    background: linear-gradient(45deg, #e74c3c, #c0392b);
}

/* Каталог товаров */
.products {
    padding: 100px 0;
    background: var(--bg-secondary);
}

.products-filter {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 50px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 10px 25px;
    background: transparent;
    color: #ecf0f1;
    border: 2px solid #e74c3c;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.filter-btn:hover,
.filter-btn.active {
    background: #e74c3c;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-top: 50px;
}

.product-card {
    background: var(--card-bg);
    border-radius: 10px;
    overflow: hidden;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
    box-shadow: 0 4px 15px var(--shadow);
}

.product-card:hover {
    transform: translateY(-10px);
    border-color: #e74c3c;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.product-image {
    width: 100%;
    height: 250px;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.product-image-placeholder {
    width: 100%;
    height: 250px;
    background: linear-gradient(135deg, #34495e, #2c3e50);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #bdc3c7;
    font-size: 1.2rem;
    border: 2px dashed #7f8c8d;
    transition: transform 0.3s ease;
}

.product-card:hover .product-image {
    transform: scale(1.05);
}

.product-card:hover .product-image-placeholder {
    transform: scale(1.05);
}

.product-info {
    padding: 20px;
}

.product-title {
    font-size: 1.3rem;
    color: #ecf0f1;
    margin-bottom: 10px;
    font-weight: 600;
}

.product-price {
    font-size: 1.5rem;
    color: #e74c3c;
    font-weight: 700;
    margin-bottom: 15px;
}

.product-description {
    color: #bdc3c7;
    line-height: 1.5;
    margin-bottom: 20px;
}

.product-category {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #e74c3c;
    color: white;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

/* Форма добавления товара */
.add-product {
    padding: 100px 0;
    background: var(--bg-primary);
}

.product-form {
    max-width: 600px;
    margin: 0 auto;
    background: var(--card-bg);
    padding: 40px;
    border-radius: 10px;
    box-shadow: 0 10px 30px var(--shadow);
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    color: var(--text-primary);
    margin-bottom: 8px;
    font-weight: 500;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid var(--border-color);
    border-radius: 5px;
    background: var(--input-bg);
    color: var(--text-primary);
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--accent-color);
}

.image-preview {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.preview-image {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 5px;
    border: 2px solid #e74c3c;
}

/* Контакты */
.contact {
    padding: 100px 0;
    background: #34495e;
}

.contact-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 50px;
    margin-top: 50px;
}

.contact-item {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
    padding: 20px;
    background: #2c3e50;
    border-radius: 10px;
    transition: transform 0.3s ease;
}

.contact-item:hover {
    transform: translateX(10px);
}

.contact-item i {
    font-size: 2rem;
    color: #e74c3c;
    margin-right: 20px;
    width: 50px;
    text-align: center;
}

.contact-item h3 {
    color: #ecf0f1;
    margin-bottom: 5px;
    font-size: 1.2rem;
}

.contact-item p {
    color: #bdc3c7;
}

.contact-form {
    background: #2c3e50;
    padding: 40px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.contact-form h3 {
    color: #ecf0f1;
    margin-bottom: 30px;
    font-size: 1.5rem;
    text-align: center;
}

.contact-form input,
.contact-form textarea {
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 20px;
    border: 2px solid #34495e;
    border-radius: 5px;
    background: #34495e;
    color: #ecf0f1;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.contact-form input:focus,
.contact-form textarea:focus {
    outline: none;
    border-color: #e74c3c;
}

/* Футер */
.footer {
    background: #2c3e50;
    padding: 30px 0;
    text-align: center;
    border-top: 2px solid #e74c3c;
}

.footer p {
    color: #bdc3c7;
}

/* Модальное окно */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
    overflow-y: auto;
    padding: 20px 0;
}

.modal-content {
    background: var(--card-bg);
    margin: 5% auto;
    padding: 0;
    border-radius: 10px;
    width: 90%;
    max-width: 800px;
    position: relative;
    animation: modalSlideIn 0.3s ease-out;
    box-shadow: 0 20px 60px var(--shadow);
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.close {
    position: absolute;
    top: 15px;
    right: 20px;
    color: #ecf0f1;
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
    z-index: 2001;
    transition: color 0.3s ease;
}

.close:hover {
    color: #e74c3c;
}

.modal-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    padding: 30px;
}

.modal-images {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.modal-images img {
    width: 100%;
    height: 300px;
    object-fit: cover;
    border-radius: 10px;
    border: 2px solid #e74c3c;
}

.modal-thumbnails {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.thumbnail {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 5px;
    border: 2px solid #34495e;
    cursor: pointer;
    transition: border-color 0.3s ease;
}

.thumbnail:hover,
.thumbnail.active {
    border-color: #e74c3c;
}

.modal-info h2 {
    color: #ecf0f1;
    margin-bottom: 15px;
    font-size: 1.8rem;
}

.modal-price {
    color: #e74c3c;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 20px;
}

.modal-description {
    color: #bdc3c7;
    line-height: 1.6;
    margin-bottom: 30px;
}

/* Адаптивность */
@media (max-width: 768px) {
    .hamburger {
        display: flex;
    }
    
    .nav-menu {
        position: fixed;
        left: -100%;
        top: 70px;
        flex-direction: column;
        background-color: rgba(44, 62, 80, 0.95);
        width: 100%;
        text-align: center;
        transition: 0.3s;
        padding: 20px 0;
    }
    
    .nav-menu.active {
        left: 0;
    }
    
    .hero-title {
        font-size: 2.5rem;
    }
    
    .hero-subtitle {
        font-size: 1.2rem;
    }
    
    .hero-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .contact-content {
        grid-template-columns: 1fr;
        gap: 30px;
    }
    
    .modal-body {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .products-grid {
        grid-template-columns: 1fr;
    }
    
    .products-filter {
        flex-direction: column;
        align-items: center;
    }
}

@media (max-width: 480px) {
    .hero-title {
        font-size: 2rem;
    }
    
    .section-title {
        font-size: 2rem;
    }
    
    .product-form,
    .contact-form {
        padding: 20px;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
}

/* Дополнительные анимации */
.fade-in {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-in-left {
    animation: slideInLeft 0.6s ease-out;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-50px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.slide-in-right {
    animation: slideInRight 0.6s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(50px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Эффект металлического блеска */
.metal-effect {
    background: linear-gradient(45deg, #34495e, #2c3e50, #34495e);
    background-size: 200% 200%;
    animation: metalShine 3s ease-in-out infinite;
}

@keyframes metalShine {
    0%, 100% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
}

/* Авторизация */
.login-section {
    padding: 100px 0;
    background: #2c3e50;
    min-height: 100vh;
    display: flex;
    align-items: center;
}

.auth-container {
    max-width: 500px;
    margin: 0 auto;
    background: #34495e;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.auth-tabs {
    display: flex;
    background: #2c3e50;
}

.tab-btn {
    flex: 1;
    padding: 15px;
    background: transparent;
    color: #bdc3c7;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.tab-btn.active {
    background: #e74c3c;
    color: white;
}

.auth-form {
    padding: 40px;
    display: none;
}

.auth-form.active {
    display: block;
}

.auth-form h2 {
    color: #ecf0f1;
    margin-bottom: 30px;
    text-align: center;
    font-size: 1.8rem;
}

/* Профиль */
.profile-section {
    padding: 100px 0;
    background: var(--bg-secondary);
}

.profile-content {
    max-width: 800px;
    margin: 0 auto;
    background: var(--card-bg);
    border-radius: 10px;
    padding: 40px;
    box-shadow: 0 10px 30px var(--shadow);
}

.profile-info {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 30px;
    border-bottom: 2px solid #34495e;
}

.profile-avatar {
    width: 100px;
    height: 100px;
    background: #e74c3c;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 30px;
    font-size: 2.5rem;
    color: white;
}

.profile-details h3 {
    color: #ecf0f1;
    font-size: 1.8rem;
    margin-bottom: 10px;
}

.profile-details p {
    color: #bdc3c7;
    margin-bottom: 5px;
}

.profile-role {
    display: inline-block;
    background: #e74c3c;
    color: white;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: 500;
    margin-top: 10px;
}

.profile-actions {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

/* Админ-панель */
.admin-panel {
    padding: 100px 0;
    background: var(--bg-primary);
}

.admin-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.admin-tab-btn {
    padding: 12px 25px;
    background: transparent;
    color: #ecf0f1;
    border: 2px solid #e74c3c;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.admin-tab-btn.active,
.admin-tab-btn:hover {
    background: #e74c3c;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}

.admin-content {
    display: none;
    background: var(--card-bg);
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 10px 30px var(--shadow);
}

.admin-content.active {
    display: block;
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.admin-header h3 {
    color: #ecf0f1;
    font-size: 1.5rem;
}

.admin-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* Управление товарами в админке */
.products-admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.admin-product-card {
    background: #2c3e50;
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    position: relative;
}

.admin-product-card:hover {
    border-color: #e74c3c;
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.admin-product-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 15px;
    z-index: 10;
}

.admin-product-actions button {
    width: 40px;
    height: 40px;
    border: 2px solid white;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.edit-btn {
    background: #3498db;
    color: white;
}

.edit-btn:hover {
    background: #2980b9;
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
}

.delete-btn {
    background: #e74c3c;
    color: white;
}

.delete-btn:hover {
    background: #c0392b;
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
}

/* Заказы */
.orders-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.order-item {
    background: #2c3e50;
    border-radius: 10px;
    padding: 20px;
    border-left: 4px solid #e74c3c;
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}

.order-id {
    color: #e74c3c;
    font-weight: 600;
}

.order-date {
    color: #bdc3c7;
    font-size: 0.9rem;
}

.order-status {
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.order-status.new {
    background: #3498db;
    color: white;
}

.order-status.processing {
    background: #f39c12;
    color: white;
}

.order-status.completed {
    background: #27ae60;
    color: white;
}

.order-details {
    color: #bdc3c7;
    line-height: 1.6;
}

.order-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* Пользователи */
.users-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.user-item {
    background: #2c3e50;
    border-radius: 10px;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-avatar {
    width: 50px;
    height: 50px;
    background: #e74c3c;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.user-details h4 {
    color: #ecf0f1;
    margin-bottom: 5px;
}

.user-details p {
    color: #bdc3c7;
    font-size: 0.9rem;
}

.user-actions {
    display: flex;
    gap: 10px;
}

/* Настройки */
.settings-form {
    max-width: 600px;
}

/* Действия форм */
.form-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 30px;
}

/* Модальные окна - дополнительные стили */
.modal-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.btn-danger {
    background: linear-gradient(45deg, #e74c3c, #c0392b);
    color: white;
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}

.btn-danger:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
}

.btn-warning {
    background: linear-gradient(45deg, #f39c12, #e67e22);
    color: white;
    box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
}

.btn-warning:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
}



/* Управление изображениями */
.current-images {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
}

.current-image {
    position: relative;
    width: 100px;
    height: 100px;
}

.current-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 5px;
    border: 2px solid #e74c3c;
}

.remove-image {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 20px;
    height: 20px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.image-manager {
    max-width: 800px;
}

.images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
    max-height: 400px;
    overflow-y: auto;
}

.image-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid #34495e;
    transition: border-color 0.3s ease;
}

.image-item:hover {
    border-color: #e74c3c;
}

.image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-item .remove-image {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 25px;
    height: 25px;
    background: rgba(231, 76, 60, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.image-item:hover .remove-image {
    opacity: 1;
}

.image-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

/* Адаптивность для новых компонентов */
@media (max-width: 768px) {
    .profile-info {
        flex-direction: column;
        text-align: center;
    }
    
    .profile-avatar {
        margin-right: 0;
        margin-bottom: 20px;
    }
    
    .admin-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .admin-tabs {
        flex-direction: column;
    }
    
    .user-item {
        flex-direction: column;
        align-items: stretch;
    }
    
    .user-info {
        justify-content: center;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .modal-actions {
        flex-direction: column;
    }
    
    .images-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
}

@media (max-width: 480px) {
    .auth-container {
        margin: 0 20px;
    }
    
    .auth-form {
        padding: 20px;
    }
    
    .profile-content {
        padding: 20px;
    }
    
    .admin-content {
        padding: 20px;
    }
    
    .images-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    }
}
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
  <!-- Навигация -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <i class="fas fa-hammer"></i>
        <span>МеталлМастер</span>
      </div>
      <ul class="nav-menu">
        <li><a href="#home" class="nav-link">Главная</a></li>
        <li><a href="#products" class="nav-link">Каталог</a></li>
        <li id="addProductLink" style="display: none;"><a href="#add-product" class="nav-link">Добавить товар</a></li>
        <li id="adminPanelLink" style="display: none;"><a href="#admin-panel" class="nav-link">Админ-панель</a></li>
        <li><a href="#contact" class="nav-link">Контакты</a></li>
        <li id="profileLink" style="display: none;"><a href="#profile" class="nav-link">Профиль</a></li>
        <li id="loginLink"><a href="#login" class="nav-link">Войти</a></li>
        <li id="logoutLink" style="display: none;"><a href="#" class="nav-link" onclick="logout()">Выйти</a></li>
        <li>
          <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Переключить тему">
            <i class="fas fa-moon"></i>
          </button>
        </li>
      </ul>
      <div class="hamburger"><span></span><span></span><span></span></div>
    </div>
  </nav>

  <!-- Главная секция -->
  <section id="home" class="hero">
    <div class="hero-content">
      <h1 class="hero-title">Мастер по металлу</h1>
      <p class="hero-subtitle">Качественные двери, заборы и кованые изделия на заказ</p>
      <div class="hero-buttons">
        <a href="#products" class="btn btn-primary">Посмотреть работы</a>
        <a href="#contact" class="btn btn-secondary">Связаться с нами</a>
      </div>
    </div>
    <div class="hero-animation">
      <div class="spark spark-1"></div>
      <div class="spark spark-2"></div>
      <div class="spark spark-3"></div>
    </div>
  </section>

  <!-- Каталог товаров -->
  <section id="products" class="products">
    <div class="container">
      <h2 class="section-title">Наши работы</h2>
      <div class="products-filter">
        <button class="filter-btn active" data-filter="all">Все</button>
        <button class="filter-btn" data-filter="doors">Двери</button>
        <button class="filter-btn" data-filter="fences">Заборы</button>
        <button class="filter-btn" data-filter="forged">Ковка</button>
      </div>
      <div class="products-grid" id="productsGrid"></div>
    </div>
  </section>

  <!-- Авторизация -->
  <section id="login" class="login-section">
    <div class="container">
      <div class="auth-container">
        <div class="auth-tabs">
          <button class="tab-btn active" data-tab="login">Вход</button>
          <button class="tab-btn" data-tab="register">Регистрация</button>
        </div>

        <form class="auth-form active" id="loginForm">
          <h2>Вход в систему</h2>
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" required />
          </div>
          <div class="form-group">
            <label for="loginPassword">Пароль</label>
            <input type="password" id="loginPassword" required />
          </div>
          <button type="submit" class="btn btn-primary">Войти</button>
        </form>

        <form class="auth-form" id="registerForm">
          <h2>Регистрация</h2>
          <div class="form-group">
            <label for="regName">Имя</label>
            <input type="text" id="regName" required />
          </div>
          <div class="form-group">
            <label for="regEmail">Email</label>
            <input type="email" id="regEmail" required />
          </div>
          <div class="form-group">
            <label for="regPassword">Пароль</label>
            <input type="password" id="regPassword" required />
          </div>
          <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Профиль -->
  <section id="profile" class="profile-section">
    <div class="container">
      <h2 class="section-title">Мой профиль</h2>
      <div class="profile-content">
        <div class="profile-info">
          <div class="profile-avatar"><i class="fas fa-user"></i></div>
          <div class="profile-details">
            <h3 id="profileName"></h3>
            <p id="profileEmail"></p>
            <p id="profilePhone"></p>
            <span class="profile-role" id="profileRole"></span>
          </div>
        </div>
        <div class="profile-actions">
          <button class="btn btn-secondary" onclick="editProfile()">Редактировать профиль</button>
          <button class="btn btn-primary" onclick="showMyOrders()">Мои заказы</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Админ-панель -->
  <section id="admin-panel" class="admin-panel">
    <div class="container">
      <h2 class="section-title">Админ-панель</h2>
      <div class="admin-tabs">
        <button class="admin-tab-btn active" data-tab="products">Управление товарами</button>
        <button class="admin-tab-btn" data-tab="orders">Заказы</button>
        <button class="admin-tab-btn" data-tab="users">Пользователи</button>
        <button class="admin-tab-btn" data-tab="settings">Настройки</button>
      </div>

      <div class="admin-content active" id="products-tab">
        <div class="admin-header">
          <h3>Управление товарами</h3>
          <div class="admin-actions">
            <button class="btn btn-primary" onclick="showAddProductForm()">Добавить товар</button>
            <button class="btn btn-success" onclick="syncDataToServer()">Синхронизировать с сервером</button>
            <button class="btn btn-danger" onclick="clearAllProducts()">Очистить все товары</button>
            <button class="btn btn-warning" onclick="removeDefaultProducts()">Удалить товары по умолчанию</button>
            <button class="btn btn-secondary" onclick="showStorageInfo()">Информация о хранилище</button>
            <button class="btn btn-warning" onclick="clearLocalStorage()">Очистить хранилище</button>
          </div>
        </div>
        <div class="products-admin-grid" id="adminProductsGrid"></div>
      </div>

      <div class="admin-content" id="orders-tab">
        <h3>Заказы клиентов</h3>
        <div class="orders-list" id="ordersList"></div>
      </div>

      <div class="admin-content" id="users-tab">
        <h3>Управление пользователями</h3>
        <div class="users-list" id="usersList"></div>
      </div>

      <div class="admin-content" id="settings-tab">
        <h3>Настройки сайта</h3>
        <form class="settings-form" id="settingsForm">
          <div class="form-group">
            <label for="siteName">Название сайта</label>
            <input type="text" id="siteName" value="МеталлМастер" />
          </div>
          <div class="form-group">
            <label for="siteDescription">Описание сайта</label>
            <textarea id="siteDescription" rows="3">Качественные двери, заборы и кованые изделия на заказ</textarea>
          </div>
          <div class="form-group">
            <label for="contactPhone">Контактный телефон</label>
            <input type="tel" id="contactPhone" value="+7 (XXX) XXX-XX-XX" />
          </div>
          <div class="form-group">
            <label for="contactEmail">Контактный email</label>
            <input type="email" id="contactEmail" value="master@metall.ru" />
          </div>
          <div class="form-group">
            <label for="contactAddress">Адрес</label>
            <input type="text" id="contactAddress" value="г. Ваш город, ул. Мастерская, д. 1" />
          </div>
          <button type="submit" class="btn btn-primary">Сохранить настройки</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Добавление товара -->
  <section id="add-product" class="add-product">
    <div class="container">
      <h2 class="section-title">Добавить новый товар</h2>
      <form class="product-form" id="productForm">
        <div class="form-group">
          <label for="productName">Название товара</label>
          <input type="text" id="productName" name="name" required />
        </div>
        <div class="form-group">
          <label for="productCategory">Категория</label>
          <select id="productCategory" name="category" required>
            <option value="">Выберите категорию</option>
            <option value="doors">Двери</option>
            <option value="fences">Заборы</option>
            <option value="forged">Ковка</option>
          </select>
        </div>
        <div class="form-group">
          <label for="productPrice">Цена (руб.)</label>
          <input type="number" id="productPrice" name="price" required />
        </div>
        <div class="form-group">
          <label for="productDescription">Описание</label>
          <textarea id="productDescription" name="description" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label for="productImages">Фотографии</label>
          <input type="file" id="productImages" name="images" multiple accept="image/*" />
          <div class="image-preview" id="imagePreview"></div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Добавить товар</button>
          <button type="button" class="btn btn-secondary" onclick="cancelAddProduct()">Отмена</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Контакты -->
  <section id="contact" class="contact">
    <div class="container">
      <h2 class="section-title">Контакты</h2>
      <div class="contact-content">
        <div class="contact-info">
          <div class="contact-item">
            <i class="fas fa-phone"></i>
            <div><h3>Телефон</h3><p>+7 (XXX) XXX-XX-XX</p></div>
          </div>
          <div class="contact-item">
            <i class="fas fa-envelope"></i>
            <div><h3>Email</h3><p>master@metall.ru</p></div>
          </div>
          <div class="contact-item">
            <i class="fas fa-map-marker-alt"></i>
            <div><h3>Адрес</h3><p>г. Ваш город, ул. Мастерская, д. 1</p></div>
          </div>
        </div>
        <div class="contact-form">
          <h3>Заказать звонок</h3>
          <form id="contactForm">
            <input type="text" name="name" placeholder="Ваше имя" required />
            <input type="tel" name="phone" placeholder="Ваш телефон" required />
            <textarea name="message" placeholder="Сообщение" rows="4"></textarea>
            <button type="submit" class="btn btn-primary">Отправить</button>
          </form>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="container"><p>&copy; 2024 МеталлМастер. Все права защищены.</p></div>
  </footer>

  <!-- Скрипты -->
  <script>
// API модуль для синхронизации данных (инлайн)
class API {
    constructor(baseUrl) {
        if (baseUrl) {
            this.baseUrl = baseUrl;
        } else {
            const isLocalhost = /localhost|127\.0\.0\.1/.test(window.location.hostname);
            this.baseUrl = isLocalhost ? 'http://localhost:3000/api' : '/api';
        }
    }
    async request(endpoint, options = {}) {
        try {
            const url = `${this.baseUrl}${endpoint}`;
            const response = await fetch(url, {
                headers: { 'Content-Type': 'application/json', ...(options.headers||{}) },
                ...options
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }
    async getProducts() { return this.request('/products'); }
    async addProduct(product) { return this.request('/products', { method: 'POST', body: JSON.stringify(product) }); }
    async updateProduct(id, product) { return this.request(`/products/${id}`, { method: 'PUT', body: JSON.stringify(product) }); }
    async deleteProduct(id) { return this.request(`/products/${id}`, { method: 'DELETE' }); }
    async getUsers() { return this.request('/users'); }
    async addUser(user) { return this.request('/users', { method: 'POST', body: JSON.stringify(user) }); }
    async updateUser(id, user) { return this.request(`/users/${id}`, { method: 'PUT', body: JSON.stringify(user) }); }
    async deleteUser(id) { return this.request(`/users/${id}`, { method: 'DELETE' }); }
    async getContacts() { return this.request('/contacts'); }
    async addContact(contact) { return this.request('/contacts', { method: 'POST', body: JSON.stringify(contact) }); }
    async getSettings() { return this.request('/settings'); }
    async updateSettings(settings) { return this.request('/settings', { method: 'PUT', body: JSON.stringify(settings) }); }
    async syncAllData(data) { return this.request('/sync', { method: 'POST', body: JSON.stringify(data) }); }
    async getAllData() { return this.request('/data'); }
}
window.api = new API();
  </script>
  <script>
// Глобальные переменные
let products = [];
let users = [];
let currentUser = null;
let currentFilter = 'all';
let currentEditingProduct = null;
let isOnline = navigator.onLine;

// Автосинхронизация с сервером (дебаунс)
let syncTimer = null;
function scheduleAutoSync() {
    if (!isOnline || !window.api) return;
    if (syncTimer) clearTimeout(syncTimer);
    syncTimer = setTimeout(() => {
        try {
            window.api.syncAllData({
                products: products,
                users: users,
                contacts: JSON.parse(localStorage.getItem('contacts')) || [],
                settings: JSON.parse(localStorage.getItem('siteSettings')) || {}
            }).then(() => {
                console.log('Автосинхронизация: успех');
            }).catch(err => console.error('Автосинхронизация: ошибка', err));
        } catch (e) {
            console.error('Автосинхронизация: исключение', e);
        }
    }, 800); // дебаунс 800 мс
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

async function initializeApp() {
    // Очищаем старые флаги товаров по умолчанию
    localStorage.removeItem('defaultProductsAdded');
    
    setupNavigation();
    setupProductForm();
    setupContactForm();
    setupModal();
    setupFilters();
    setupAuth();
    setupAdminPanel();
    setupTheme();
    setupScrollAnimations();
    
    // Загружаем данные с сервера или из localStorage
    await loadDataFromServer();
    
    // Инициализируем остальные компоненты
    loadProducts();
    addSampleUsers();
    updateNavigation();
    updateContactDisplay();
    
    // Отладочная информация
    console.log('Приложение инициализировано');
    console.log('Текущий пользователь:', currentUser);
    console.log('Все пользователи:', users);
    console.log('Товары при инициализации:', products);
}

// Функции для работы с API
async function loadDataFromServer() {
    try {
        if (isOnline && window.api) {
            console.log('Загружаем данные с сервера...');
            const serverData = await window.api.getAllData();
            
            products = serverData.products || [];
            users = serverData.users || [];
            
            // Загружаем текущего пользователя из localStorage
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
            }
            
            console.log('Данные загружены с сервера');
        } else {
            console.log('Сервер недоступен, загружаем из localStorage...');
            await loadDataFromLocalStorage();
        }
    } catch (error) {
        console.error('Ошибка загрузки с сервера:', error);
        await loadDataFromLocalStorage();
    }
}

async function loadDataFromLocalStorage() {
    const storedProducts = localStorage.getItem('products');
    const storedUsers = localStorage.getItem('users');
    const storedUser = localStorage.getItem('currentUser');
    
    if (storedProducts) {
        products = JSON.parse(storedProducts);
    }
    if (storedUsers) {
        users = JSON.parse(storedUsers);
    }
    if (storedUser) {
        currentUser = JSON.parse(storedUser);
    }
}

async function syncDataToServer() {
    try {
        if (isOnline && window.api) {
            await window.api.syncAllData({
                products: products,
                users: users,
                contacts: JSON.parse(localStorage.getItem('contacts')) || [],
                settings: JSON.parse(localStorage.getItem('siteSettings')) || {}
            });
            console.log('Данные синхронизированы с сервером');
        }
    } catch (error) {
        console.error('Ошибка синхронизации с сервером:', error);
    }
}

// Навигация
function setupNavigation() {
    const hamburger = document.querySelector('.hamburger');
    const navMenu = document.querySelector('.nav-menu');
    const navLinks = document.querySelectorAll('.nav-link');

    // Мобильное меню
    hamburger.addEventListener('click', function() {
        navMenu.classList.toggle('active');
        hamburger.classList.toggle('active');
    });

    // Плавная прокрутка к секциям
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetSection = document.querySelector(targetId);
            
            if (targetSection) {
                // Специальная обработка для кнопки "Войти"
                if (targetId === '#login') {
                    document.getElementById('login').style.display = 'block';
                } else {
                    // Скрываем форму входа при переходе на другие страницы
                    document.getElementById('login').style.display = 'none';
                }
                
                targetSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Закрыть мобильное меню
                navMenu.classList.remove('active');
                hamburger.classList.remove('active');
            }
        });
    });

    // Изменение навигации при прокрутке
    window.addEventListener('scroll', function() {
        const navbar = document.querySelector('.navbar');
        if (window.scrollY > 100) {
            navbar.style.background = 'rgba(44, 62, 80, 0.98)';
        } else {
            navbar.style.background = 'rgba(44, 62, 80, 0.95)';
        }
    });
}

// Форма добавления товара
function setupProductForm() {
    const form = document.getElementById('productForm');
    const imageInput = document.getElementById('productImages');
    const imagePreview = document.getElementById('imagePreview');

    // Предварительный просмотр изображений
    imageInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        imagePreview.innerHTML = '';
        
        files.forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    imagePreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
    });

    // Отправка формы
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Проверяем, что пользователь авторизован как админ
        if (!currentUser || currentUser.role !== 'admin') {
            showNotification('Только администраторы могут добавлять товары', 'error');
            return;
        }
        
        const formData = new FormData(form);
        const product = {
            id: Date.now(),
            name: formData.get('name'),
            category: formData.get('category'),
            price: parseInt(formData.get('price')),
            description: formData.get('description'),
            images: [],
            dateAdded: new Date().toISOString()
        };

        // Проверяем обязательные поля
        if (!product.name || !product.category || !product.price || !product.description) {
            showNotification('Пожалуйста, заполните все обязательные поля', 'error');
            return;
        }

        // Обработка изображений с сжатием
        const files = Array.from(imageInput.files);
        let processedImages = 0;
        
        if (files.length > 0) {
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    // Сжимаем изображение перед сохранением
                    compressImage(file, 800, 600, 0.7).then(compressedImage => {
                        product.images.push(compressedImage);
                        processedImages++;
                        
                        console.log(`Изображение ${processedImages} из ${files.length} сжато и добавлено`);
                        
                        // Если обработали все изображения, сохраняем товар
                        if (processedImages === files.length) {
                            saveProduct(product);
                        }
                    });
                } else {
                    processedImages++;
                    if (processedImages === files.length) {
                        saveProduct(product);
                    }
                }
            });
        } else {
            // Если нет изображений, сохраняем товар сразу
            saveProduct(product);
        }
    });
}

async function saveProduct(product) {
    console.log('saveProduct вызвана с товаром:', product);
    console.log('Текущий массив products до добавления:', products);
    
    // Проверяем размер localStorage перед сохранением
    cleanupOldData();
    
    // Добавляем анимацию загрузки
    showProductAddingAnimation();
    
    // Небольшая задержка для демонстрации анимации
    setTimeout(async () => {
        try {
            // Добавляем товар в массив
            products.push(product);
            
            console.log('Товар добавлен в массив. Новый массив:', products);
            
            // Сохраняем в localStorage
            const productsJson = JSON.stringify(products);
            localStorage.setItem('products', productsJson);
            scheduleAutoSync();
            
            // Синхронизируем с сервером
            await syncDataToServer();
            
            console.log('Товар сохранен в localStorage и синхронизирован с сервером');
            console.log('Размер localStorage:', checkLocalStorageSize(), 'символов');
            
            // Очистка формы
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            
            // Обновление отображения в основном каталоге
            console.log('Вызываем loadProducts()');
            loadProducts();
            
            // Обновление отображения в админ-панели
            if (currentUser && currentUser.role === 'admin') {
                console.log('Вызываем loadAdminProducts()');
                loadAdminProducts();
            }
            
            // Показ уведомления об успехе
            showProductSuccessNotification(product.name);
            
            // Прокрутка к каталогу
            document.getElementById('products').scrollIntoView({
                behavior: 'smooth'
            });
        } catch (error) {
            console.error('Ошибка сохранения товара:', error);
            showNotification('Ошибка сохранения товара', 'error');
        }
    }, 1500);
}

// Форма контактов
function setupContactForm() {
    const form = document.getElementById('contactForm');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const contactData = {
            name: formData.get('name'),
            phone: formData.get('phone'),
            message: formData.get('message'),
            date: new Date().toISOString()
        };
        
        // Проверяем, что все поля заполнены
        if (!contactData.name || !contactData.phone || !contactData.message) {
            showNotification('Пожалуйста, заполните все поля', 'error');
            return;
        }
        
        // Сохранение заявки в localStorage
        let contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        contacts.push(contactData);
        localStorage.setItem('contacts', JSON.stringify(contacts));
        scheduleAutoSync();
        
        console.log('Контактная заявка сохранена:', contactData);
        console.log('Все заявки:', contacts);
        
        // Очистка формы
        form.reset();
        
        // Показ уведомления
        showNotification('Заявка отправлена! Мы свяжемся с вами в ближайшее время.', 'success');
    });
}

// Модальное окно
function setupModal() {
    const modal = document.getElementById('productModal');
    if (!modal) {
        return;
    }
    const closeBtn = modal.querySelector('.close');
    const orderBtn = document.getElementById('orderBtn');
    
    // Закрытие модального окна
    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }
    window.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Кнопка заказа
    if (orderBtn) {
        orderBtn.addEventListener('click', function() {
            const titleEl = document.getElementById('modalTitle');
            const productName = titleEl ? titleEl.textContent : '';
            showNotification(`Заказ на "${productName}" отправлен!`, 'success');
            closeModal();
        });
    }
}

function openModal(product) {
    const modal = document.getElementById('productModal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalTitle');
    const modalPrice = document.getElementById('modalPrice');
    const modalDescription = document.getElementById('modalDescription');
    const modalThumbnails = document.getElementById('modalThumbnails');
    const editBtn = document.getElementById('editBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    
    // Заполнение данных
    modalTitle.textContent = product.name;
    modalPrice.textContent = `${product.price.toLocaleString()} руб.`;
    modalDescription.textContent = product.description;
    
    // Показываем кнопки редактирования и удаления только для админов
    if (currentUser && currentUser.role === 'admin') {
        editBtn.style.display = 'inline-block';
        deleteBtn.style.display = 'inline-block';
        editBtn.onclick = () => {
            closeModal();
            editProduct(product.id);
        };
        deleteBtn.onclick = () => {
            closeModal();
            deleteProduct(product.id);
        };
    } else {
        editBtn.style.display = 'none';
        deleteBtn.style.display = 'none';
    }
    
    // Обработка изображений
    if (product.images && product.images.length > 0) {
        modalImage.src = product.images[0];
        modalThumbnails.innerHTML = '';
        
        product.images.forEach((image, index) => {
            const thumbnail = document.createElement('img');
            thumbnail.src = image;
            thumbnail.className = 'thumbnail';
            if (index === 0) thumbnail.classList.add('active');
            
            thumbnail.addEventListener('click', function() {
                modalImage.src = image;
                document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            });
            
            modalThumbnails.appendChild(thumbnail);
        });
    } else {
        // Скрываем изображение если его нет
        modalImage.style.display = 'none';
        modalThumbnails.innerHTML = '';
    }
    
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    const modal = document.getElementById('productModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Фильтры товаров
function setupFilters() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Удаляем активный класс со всех кнопок
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Добавляем активный класс к текущей кнопке
            this.classList.add('active');
            
            // Устанавливаем текущий фильтр
            currentFilter = this.getAttribute('data-filter');
            
            // Фильтруем товары
            filterProducts();
        });
    });
}

function filterProducts() {
    const productCards = document.querySelectorAll('.product-card');
    
    productCards.forEach(card => {
        const category = card.getAttribute('data-category');
        
        if (currentFilter === 'all' || category === currentFilter) {
            card.style.display = 'block';
            card.classList.add('fade-in');
        } else {
            card.style.display = 'none';
        }
    });
}

// Загрузка и отображение товаров
function loadProducts() {
    console.log('loadProducts вызвана');
    
    // Обновляем массив products из localStorage
    const storedProducts = localStorage.getItem('products');
    console.log('storedProducts из localStorage:', storedProducts);
    
    if (storedProducts) {
        products = JSON.parse(storedProducts);
        console.log('products обновлен из localStorage:', products);
    }
    
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) {
        console.error('productsGrid не найден!');
        return;
    }
    
    productsGrid.innerHTML = '';
    
    console.log('loadProducts: товаров в массиве:', products.length);
    console.log('loadProducts: товары:', products);
    
    if (products.length === 0) {
        productsGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; color: #bdc3c7; padding: 50px;">
                <i class="fas fa-hammer" style="font-size: 3rem; margin-bottom: 20px; color: #e74c3c;"></i>
                <h3>Пока нет товаров</h3>
                <p>Добавьте первый товар, используя форму выше</p>
            </div>
        `;
        return;
    }
    
    products.forEach((product, index) => {
        console.log(`Создаем карточку для товара ${index}:`, product);
        const productCard = createProductCard(product);
        productsGrid.appendChild(productCard);
    });
    
    // Применяем текущий фильтр
    filterProducts();
}

function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.setAttribute('data-category', product.category);
    
    const categoryNames = {
        'doors': 'Двери',
        'fences': 'Заборы',
        'forged': 'Ковка'
    };
    
    // Создаем изображение только если оно есть
    let imageHtml = '';
    if (product.images && product.images.length > 0) {
        imageHtml = `<img src="${product.images[0]}" alt="${product.name}" class="product-image">`;
    } else {
        // Создаем пустой блок для изображения без текста
        imageHtml = `<div class="product-image-placeholder"></div>`;
    }
    
    card.innerHTML = `
        <div class="product-category">${categoryNames[product.category] || product.category}</div>
        ${imageHtml}
        <div class="product-info">
            <h3 class="product-title">${product.name}</h3>
            <div class="product-price">${product.price.toLocaleString()} руб.</div>
            <p class="product-description">${product.description}</p>
            <button class="btn btn-primary" onclick="openModal(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                Подробнее
            </button>
        </div>
    `;
    
    return card;
}



// Анимации при прокрутке
function setupScrollAnimations() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('fade-in');
            }
        });
    }, observerOptions);
    
    // Наблюдаем за секциями
    const sections = document.querySelectorAll('section');
    sections.forEach(section => {
        observer.observe(section);
    });
    
    // Наблюдаем за карточками товаров
    const productCards = document.querySelectorAll('.product-card');
    productCards.forEach(card => {
        observer.observe(card);
    });
}

// Анимация добавления товара
function showProductAddingAnimation() {
    // Создаем оверлей для анимации
    const overlay = document.createElement('div');
    overlay.id = 'productAddingOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 5000;
        backdrop-filter: blur(5px);
    `;
    
    // Создаем контейнер для анимации
    const animationContainer = document.createElement('div');
    animationContainer.style.cssText = `
        text-align: center;
        color: white;
    `;
    
    // Создаем анимированную иконку
    const icon = document.createElement('div');
    icon.innerHTML = '<i class="fas fa-hammer" style="font-size: 4rem; color: #e74c3c; animation: hammerWork 1s infinite;"></i>';
    
    // Создаем текст
    const text = document.createElement('div');
    text.innerHTML = '<h3 style="margin-top: 20px; font-size: 1.5rem;">Добавляем товар...</h3>';
    
    // Создаем прогресс-бар
    const progressBar = document.createElement('div');
    progressBar.style.cssText = `
        width: 300px;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        margin-top: 20px;
        overflow: hidden;
    `;
    
    const progressFill = document.createElement('div');
    progressFill.style.cssText = `
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #e74c3c, #c0392b);
        border-radius: 2px;
        animation: progressFill 1.5s ease-out forwards;
    `;
    
    progressBar.appendChild(progressFill);
    
    animationContainer.appendChild(icon);
    animationContainer.appendChild(text);
    animationContainer.appendChild(progressBar);
    overlay.appendChild(animationContainer);
    
    document.body.appendChild(overlay);
    
    // Добавляем CSS анимации
    const style = document.createElement('style');
    style.textContent = `
        @keyframes hammerWork {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-15deg) scale(1.1); }
            50% { transform: rotate(0deg) scale(1.2); }
            75% { transform: rotate(15deg) scale(1.1); }
        }
        
        @keyframes progressFill {
            0% { width: 0%; }
            100% { width: 100%; }
        }
    `;
    document.head.appendChild(style);
    
    // Удаляем оверлей через 1.5 секунды
    setTimeout(() => {
        if (overlay.parentNode) {
            overlay.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                overlay.remove();
                style.remove();
            }, 300);
        }
    }, 1500);
}

// Анимация сохранения изменений
function showSavingAnimation() {
    // Создаем оверлей для анимации
    const overlay = document.createElement('div');
    overlay.id = 'savingOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 6000;
        backdrop-filter: blur(5px);
    `;
    
    // Создаем контейнер для анимации
    const animationContainer = document.createElement('div');
    animationContainer.style.cssText = `
        text-align: center;
        color: white;
    `;
    
    // Создаем анимированную иконку
    const icon = document.createElement('div');
    icon.innerHTML = '<i class="fas fa-save" style="font-size: 4rem; color: #27ae60; animation: savePulse 1s infinite;"></i>';
    
    // Создаем текст
    const text = document.createElement('div');
    text.innerHTML = '<h3 style="margin-top: 20px; font-size: 1.5rem;">Сохраняем изменения...</h3>';
    
    // Создаем прогресс-бар
    const progressBar = document.createElement('div');
    progressBar.style.cssText = `
        width: 300px;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        margin-top: 20px;
        overflow: hidden;
    `;
    
    const progressFill = document.createElement('div');
    progressFill.style.cssText = `
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #2ecc71);
        border-radius: 2px;
        animation: progressFill 1.5s ease-out forwards;
    `;
    
    progressBar.appendChild(progressFill);
    
    animationContainer.appendChild(icon);
    animationContainer.appendChild(text);
    animationContainer.appendChild(progressBar);
    overlay.appendChild(animationContainer);
    
    document.body.appendChild(overlay);
    
    // Добавляем CSS анимации
    const style = document.createElement('style');
    style.textContent = `
        @keyframes savePulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        @keyframes progressFill {
            0% { width: 0%; }
            100% { width: 100%; }
        }
    `;
    document.head.appendChild(style);
    
    // Удаляем оверлей через 1.5 секунды
    setTimeout(() => {
        if (overlay.parentNode) {
            overlay.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                overlay.remove();
                style.remove();
            }, 300);
        }
    }, 1500);
}

// Уведомление об успешном добавлении товара
function showProductSuccessNotification(productName) {
    // Создаем специальное уведомление
    const notification = document.createElement('div');
    notification.className = 'product-success-notification';
    notification.innerHTML = `
        <div class="success-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="success-text">
                <h3>Товар успешно добавлен!</h3>
                <p>"${productName}" теперь доступен в каталоге</p>
            </div>
            <button class="success-close">&times;</button>
        </div>
    `;
    
    // Стили для уведомления
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(39, 174, 96, 0.4);
        z-index: 4000;
        animation: slideInSuccess 0.5s ease-out;
        max-width: 400px;
        border: 2px solid rgba(255, 255, 255, 0.2);
    `;
    
    notification.querySelector('.success-content').style.cssText = `
        display: flex;
        align-items: center;
        gap: 15px;
    `;
    
    notification.querySelector('.success-icon').style.cssText = `
        font-size: 2.5rem;
        animation: bounceIn 0.6s ease-out;
    `;
    
    notification.querySelector('.success-text h3').style.cssText = `
        margin: 0 0 5px 0;
        font-size: 1.2rem;
        font-weight: 600;
    `;
    
    notification.querySelector('.success-text p').style.cssText = `
        margin: 0;
        opacity: 0.9;
        font-size: 0.9rem;
    `;
    
    notification.querySelector('.success-close').style.cssText = `
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        margin-left: auto;
        padding: 5px;
        border-radius: 50%;
        transition: background 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // Добавляем CSS анимации
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInSuccess {
            from {
                opacity: 0;
                transform: translateX(100%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .success-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    `;
    document.head.appendChild(style);
    
    // Закрытие уведомления
    notification.querySelector('.success-close').addEventListener('click', function() {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            notification.remove();
            style.remove();
        }, 300);
    });
    
    // Автоматическое закрытие через 6 секунд
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
                notification.remove();
                style.remove();
            }, 300);
        }
    }, 6000);
}

// Уведомления
function showNotification(message, type = 'info') {
    // Удаляем существующие уведомления
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
            <span>${message}</span>
            <button class="notification-close">&times;</button>
        </div>
    `;
    
    // Стили для уведомления
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#27ae60' : '#3498db'};
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 3000;
        animation: slideInRight 0.3s ease-out;
        max-width: 400px;
    `;
    
    notification.querySelector('.notification-content').style.cssText = `
        display: flex;
        align-items: center;
        gap: 10px;
    `;
    
    notification.querySelector('.notification-close').style.cssText = `
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        margin-left: auto;
    `;
    
    document.body.appendChild(notification);
    
    // Закрытие уведомления
    notification.querySelector('.notification-close').addEventListener('click', function() {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    });
    
    // Автоматическое закрытие через 5 секунд
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

// Дополнительные CSS анимации для уведомлений
const notificationStyles = document.createElement('style');
notificationStyles.textContent = `
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }
`;
document.head.appendChild(notificationStyles);

// Утилиты
function formatPrice(price) {
    return new Intl.NumberFormat('ru-RU').format(price);
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('ru-RU');
}

// Функция сжатия изображения
function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.8) {
    return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            // Вычисляем новые размеры
            let { width, height } = img;
            
            if (width > height) {
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }
            }
            
            // Устанавливаем размеры canvas
            canvas.width = width;
            canvas.height = height;
            
            // Рисуем сжатое изображение
            ctx.drawImage(img, 0, 0, width, height);
            
            // Конвертируем в base64 с заданным качеством
            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(compressedDataUrl);
        };
        
        img.src = URL.createObjectURL(file);
    });
}

// Функция проверки размера localStorage
function checkLocalStorageSize() {
    let totalSize = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            totalSize += localStorage[key].length;
        }
    }
    return totalSize; // размер в символах
}

// Функция очистки старых данных при переполнении
function cleanupOldData() {
    const maxSize = 4 * 1024 * 1024; // 4MB в символах (примерно)
    const currentSize = checkLocalStorageSize();
    
    if (currentSize > maxSize) {
        console.log('localStorage переполнен, очищаем старые данные...');
        
        // Удаляем старые контакты (оставляем только последние 50)
        const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        if (contacts.length > 50) {
            const recentContacts = contacts.slice(-50);
            localStorage.setItem('contacts', JSON.stringify(recentContacts));
            scheduleAutoSync();
            console.log('Удалены старые контакты');
        }
        
        // Удаляем старые товары без изображений (оставляем только последние 100)
        const products = JSON.parse(localStorage.getItem('products')) || [];
        if (products.length > 100) {
            const recentProducts = products.slice(-100);
            localStorage.setItem('products', JSON.stringify(recentProducts));
            scheduleAutoSync();
            console.log('Удалены старые товары');
        }
    }
}

// Система авторизации
function setupAuth() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const tabButtons = document.querySelectorAll('.tab-btn');
    
    // Переключение между вкладками
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // Убираем активный класс со всех кнопок и форм
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            
            // Добавляем активный класс к выбранной кнопке и форме
            this.classList.add('active');
            document.getElementById(tabName + 'Form').classList.add('active');
        });
    });
    
    // Обработка формы входа
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        console.log('Попытка входа:', { email, password });
        console.log('Доступные пользователи:', users);
        
        const user = users.find(u => u.email === email && u.password === password);
        
        if (user) {
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateNavigation();
            showNotification('Добро пожаловать, ' + user.name + '!', 'success');
            
            // Переход на главную страницу
            document.getElementById('home').scrollIntoView({ behavior: 'smooth' });
        } else {
            showNotification('Неверный email или пароль', 'error');
            console.log('Пользователь не найден');
        }
    });
    
    // Обработка формы регистрации
    registerForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('regName').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        
        // Проверяем, не существует ли уже пользователь с таким email
        if (users.find(u => u.email === email)) {
            showNotification('Пользователь с таким email уже существует', 'error');
            return;
        }
        
        // Проверяем валидность email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showNotification('Пожалуйста, введите корректный email адрес', 'error');
            return;
        }
        
        // Проверяем длину пароля
        if (password.length < 6) {
            showNotification('Пароль должен содержать минимум 6 символов', 'error');
            return;
        }
        
        const newUser = {
            id: Date.now(),
            name: name,
            email: email,
            password: password,
            phone: 'Не указан',
            role: 'user', // Все новые пользователи только обычные пользователи
            dateRegistered: new Date().toISOString()
        };
        
        users.push(newUser);
        localStorage.setItem('users', JSON.stringify(users));
        scheduleAutoSync();
        scheduleAutoSync();
        scheduleAutoSync();
        scheduleAutoSync();
        
        // Синхронизируем с сервером
        await syncDataToServer();
        
        // Автоматический вход после регистрации
        currentUser = newUser;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        updateNavigation();
        
        showNotification('Регистрация успешна! Добро пожаловать, ' + name + '!', 'success');
        
        // Переход на главную страницу
        document.getElementById('home').scrollIntoView({ behavior: 'smooth' });
    });
}

function updateNavigation() {
    const loginLink = document.getElementById('loginLink');
    const logoutLink = document.getElementById('logoutLink');
    const profileLink = document.getElementById('profileLink');
    const addProductLink = document.getElementById('addProductLink');
    const adminPanelLink = document.getElementById('adminPanelLink');
    
    // Скрываем все секции по умолчанию
    document.getElementById('profile').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'none';
    document.getElementById('add-product').style.display = 'none';
    document.getElementById('login').style.display = 'none';
    
    if (currentUser) {
        loginLink.style.display = 'none';
        logoutLink.style.display = 'block';
        profileLink.style.display = 'block';
        
        // Показываем профиль для всех авторизованных пользователей
        document.getElementById('profile').style.display = 'block';
        
        // Загружаем данные профиля
        loadProfile();
        
        if (currentUser.role === 'admin') {
            addProductLink.style.display = 'block';
            adminPanelLink.style.display = 'block';
            document.getElementById('add-product').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'block';
        } else {
            addProductLink.style.display = 'none';
            adminPanelLink.style.display = 'none';
        }
    } else {
        loginLink.style.display = 'block';
        logoutLink.style.display = 'none';
        profileLink.style.display = 'none';
        addProductLink.style.display = 'none';
        adminPanelLink.style.display = 'none';
        document.getElementById('login').style.display = 'block';
    }
}

function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    updateNavigation();
    showNotification('Вы вышли из системы', 'info');
    
    // Переход на главную страницу
    document.getElementById('home').scrollIntoView({ behavior: 'smooth' });
}

function addSampleUsers() {
    // Всегда обновляем тестовых пользователей для отладки
    const sampleUsers = [
        {
            id: 1,
            name: 'Отец (Администратор)',
            email: 'father@metall.ru',
            password: 'father123',
            phone: '+7 (999) 123-45-67',
            role: 'admin',
            dateRegistered: new Date().toISOString()
        },
        {
            id: 2,
            name: 'Иван Петров',
            email: 'user@example.com',
            password: 'user123',
            phone: '+7 (999) 765-43-21',
            role: 'user',
            dateRegistered: new Date().toISOString()
        }
    ];
    
    // Проверяем, есть ли уже пользователи с такими email
    const existingEmails = users.map(u => u.email);
    const newUsers = sampleUsers.filter(user => !existingEmails.includes(user.email));
    
    if (newUsers.length > 0) {
        users = [...users, ...newUsers];
        localStorage.setItem('users', JSON.stringify(users));
        scheduleAutoSync();
        console.log('Добавлены тестовые пользователи:', newUsers);
    }
}

// Управление профилем
function loadProfile() {
    if (!currentUser) {
        // Если пользователь не авторизован, показываем заглушку
        document.getElementById('profileName').textContent = 'Не авторизован';
        document.getElementById('profileEmail').textContent = 'Войдите в систему';
        document.getElementById('profilePhone').textContent = '—';
        document.getElementById('profileRole').textContent = 'Гость';
        return;
    }
    
    document.getElementById('profileName').textContent = currentUser.name;
    document.getElementById('profileEmail').textContent = currentUser.email;
    document.getElementById('profilePhone').textContent = currentUser.phone || 'Не указан';
    document.getElementById('profileRole').textContent = currentUser.role === 'admin' ? 'Администратор' : 'Пользователь';
    
    // Добавляем дополнительную информацию
    const profileDetails = document.querySelector('.profile-details');
    if (profileDetails && !profileDetails.querySelector('.profile-stats')) {
        const statsDiv = document.createElement('div');
        statsDiv.className = 'profile-stats';
        statsDiv.innerHTML = `
            <p><strong>Дата регистрации:</strong> ${formatDate(currentUser.dateRegistered)}</p>
            <p><strong>Статус:</strong> ${currentUser.role === 'admin' ? 'Активный администратор' : 'Активный пользователь'}</p>
        `;
        profileDetails.appendChild(statsDiv);
    }
}

function editProfile() {
    if (!currentUser) return;
    
    const newName = prompt('Введите новое имя:', currentUser.name);
    if (newName && newName.trim()) {
        const newPhone = prompt('Введите новый телефон:', currentUser.phone);
        
        currentUser.name = newName.trim();
        if (newPhone) currentUser.phone = newPhone.trim();
        
        // Обновляем в массиве пользователей
        const userIndex = users.findIndex(u => u.id === currentUser.id);
        if (userIndex !== -1) {
            users[userIndex] = currentUser;
            localStorage.setItem('users', JSON.stringify(users));
            scheduleAutoSync();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
        
        loadProfile();
        showNotification('Профиль обновлен', 'success');
    }
}

function showMyOrders() {
    showNotification('Функция "Мои заказы" будет добавлена в следующей версии', 'info');
}

// Админ-панель
function setupAdminPanel() {
    const adminTabButtons = document.querySelectorAll('.admin-tab-btn');
    
    adminTabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // Убираем активный класс со всех кнопок и контента
            adminTabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(content => content.classList.remove('active'));
            
            // Добавляем активный класс к выбранной кнопке и контенту
            this.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Загружаем соответствующий контент
            switch(tabName) {
                case 'products':
                    loadAdminProducts();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        });
    });
    
    // Настройки сайта
    const settingsForm = document.getElementById('settingsForm');
    settingsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Собираем данные из формы
        const settings = {
            siteName: document.getElementById('siteName').value,
            siteDescription: document.getElementById('siteDescription').value,
            contactPhone: document.getElementById('contactPhone').value,
            contactEmail: document.getElementById('contactEmail').value,
            contactAddress: document.getElementById('contactAddress').value
        };
        
        // Сохраняем в localStorage
        localStorage.setItem('siteSettings', JSON.stringify(settings));
        scheduleAutoSync();
        
        // Обновляем отображение контактной информации на сайте
        updateContactDisplay();
        
        showNotification('Настройки сохранены', 'success');
    });
}

function loadAdminProducts() {
    // Обновляем массив products из localStorage
    const storedProducts = localStorage.getItem('products');
    if (storedProducts) {
        products = JSON.parse(storedProducts);
    }
    
    const adminProductsGrid = document.getElementById('adminProductsGrid');
    adminProductsGrid.innerHTML = '';
    
    console.log('loadAdminProducts вызвана, товаров:', products.length);
    
    if (products.length === 0) {
        adminProductsGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; color: #bdc3c7; padding: 50px;">
                <i class="fas fa-hammer" style="font-size: 3rem; margin-bottom: 20px; color: #e74c3c;"></i>
                <h3>Нет товаров</h3>
                <p>Добавьте первый товар</p>
            </div>
        `;
        return;
    }
    
    products.forEach(product => {
        const productCard = createAdminProductCard(product);
        adminProductsGrid.appendChild(productCard);
    });
}

function createAdminProductCard(product) {
    const card = document.createElement('div');
    card.className = 'admin-product-card';
    
    const categoryNames = {
        'doors': 'Двери',
        'fences': 'Заборы',
        'forged': 'Ковка'
    };
    
    // Создаем изображение только если оно есть
    let imageHtml = '';
    if (product.images && product.images.length > 0) {
        imageHtml = `<img src="${product.images[0]}" alt="${product.name}" class="product-image">`;
    } else {
        // Создаем пустой блок для изображения без текста
        imageHtml = `<div class="product-image-placeholder"></div>`;
    }
    
    card.innerHTML = `
        <div class="admin-product-actions">
            <button class="edit-btn" onclick="editProduct(${product.id})" title="Редактировать">
                <i class="fas fa-edit"></i>
            </button>
            <button class="delete-btn" onclick="deleteProduct(${product.id})" title="Удалить">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        ${imageHtml}
        <div class="product-info">
            <h3 class="product-title">${product.name}</h3>
            <div class="product-price">${product.price.toLocaleString()} руб.</div>
            <p class="product-description">${product.description}</p>
            <div class="product-category">${categoryNames[product.category] || product.category}</div>
        </div>
    `;
    
    return card;
}

function loadOrders() {
    const ordersList = document.getElementById('ordersList');
    const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
    
    if (contacts.length === 0) {
        ordersList.innerHTML = `
            <div style="text-align: center; color: #bdc3c7; padding: 50px;">
                <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 20px; color: #e74c3c;"></i>
                <h3>Нет заказов</h3>
                <p>Заказы будут отображаться здесь</p>
            </div>
        `;
        return;
    }
    
    ordersList.innerHTML = '';
    contacts.forEach((contact, index) => {
        const orderItem = document.createElement('div');
        orderItem.className = 'order-item';
        orderItem.innerHTML = `
            <div class="order-header">
                <span class="order-id">Заказ #${index + 1}</span>
                <span class="order-date">${formatDate(contact.date)}</span>
                <span class="order-status new">Новый</span>
            </div>
            <div class="order-details">
                <p><strong>Имя:</strong> ${contact.name}</p>
                <p><strong>Телефон:</strong> ${contact.phone}</p>
                <p><strong>Сообщение:</strong> ${contact.message}</p>
            </div>
            <div class="order-actions">
                <button class="btn btn-primary" onclick="updateOrderStatus(${index}, 'processing')">В обработку</button>
                <button class="btn btn-secondary" onclick="updateOrderStatus(${index}, 'completed')">Завершить</button>
            </div>
        `;
        ordersList.appendChild(orderItem);
    });
}

function loadUsers() {
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = '';
    
    // Только отец может управлять пользователями
    const canManageUsers = currentUser && currentUser.email === 'father@metall.ru';
    
    users.forEach(user => {
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        
        let actionsHtml = '';
        if (canManageUsers) {
            actionsHtml = `
                <button class="btn btn-secondary" onclick="editUser(${user.id})">Редактировать</button>
                ${user.id !== currentUser.id && user.email !== 'father@metall.ru' ? `<button class="btn btn-danger" onclick="deleteUser(${user.id})">Удалить</button>` : ''}
            `;
        } else {
            actionsHtml = '<span style="color: #bdc3c7;">Только просмотр</span>';
        }
        
        userItem.innerHTML = `
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <h4>${user.name} ${user.email === 'father@metall.ru' ? '(Главный администратор)' : ''}</h4>
                    <p>${user.email}</p>
                    <p>${user.phone}</p>
                    <span class="profile-role">${user.role === 'admin' ? 'Администратор' : 'Пользователь'}</span>
                </div>
            </div>
            <div class="user-actions">
                ${actionsHtml}
            </div>
        `;
        usersList.appendChild(userItem);
    });
}

function loadSettings() {
    // Загружаем текущие настройки
    const settings = JSON.parse(localStorage.getItem('siteSettings')) || {
        siteName: 'МеталлМастер',
        siteDescription: 'Качественные двери, заборы и кованые изделия на заказ',
        contactPhone: '+7 (XXX) XXX-XX-XX',
        contactEmail: 'master@metall.ru',
        contactAddress: 'г. Ваш город, ул. Мастерская, д. 1'
    };
    
    document.getElementById('siteName').value = settings.siteName;
    document.getElementById('siteDescription').value = settings.siteDescription;
    document.getElementById('contactPhone').value = settings.contactPhone;
    document.getElementById('contactEmail').value = settings.contactEmail;
    document.getElementById('contactAddress').value = settings.contactAddress;
}

// Функция для обновления отображения контактной информации на сайте
function updateContactDisplay() {
    const settings = JSON.parse(localStorage.getItem('siteSettings')) || {
        contactPhone: '+7 (XXX) XXX-XX-XX',
        contactEmail: 'master@metall.ru',
        contactAddress: 'г. Ваш город, ул. Мастерская, д. 1'
    };
    
    // Обновляем контактную информацию в секции контактов
    const contactPhoneElement = document.querySelector('.contact-item:nth-child(1) p');
    const contactEmailElement = document.querySelector('.contact-item:nth-child(2) p');
    const contactAddressElement = document.querySelector('.contact-item:nth-child(3) p');
    
    if (contactPhoneElement) contactPhoneElement.textContent = settings.contactPhone;
    if (contactEmailElement) contactEmailElement.textContent = settings.contactEmail;
    if (contactAddressElement) contactAddressElement.textContent = settings.contactAddress;
}

// Управление товарами
function showAddProductForm() {
    document.getElementById('add-product').scrollIntoView({ behavior: 'smooth' });
}

function cancelAddProduct() {
    document.getElementById('productForm').reset();
    document.getElementById('imagePreview').innerHTML = '';
    document.getElementById('home').scrollIntoView({ behavior: 'smooth' });
}

function editProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    currentEditingProduct = product;
    
    // Заполняем форму редактирования
    document.getElementById('editProductId').value = product.id;
    document.getElementById('editProductName').value = product.name;
    document.getElementById('editProductCategory').value = product.category;
    document.getElementById('editProductPrice').value = product.price;
    document.getElementById('editProductDescription').value = product.description;
    
    // Показываем текущие изображения
    const currentImages = document.getElementById('currentImages');
    currentImages.innerHTML = '';
    
    if (product.images && product.images.length > 0) {
        product.images.forEach((image, index) => {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'current-image';
            imageDiv.innerHTML = `
                <img src="${image}" alt="Изображение ${index + 1}">
                <button class="remove-image" onclick="removeProductImage(${product.id}, ${index})">&times;</button>
            `;
            currentImages.appendChild(imageDiv);
        });
    }
    
    // Открываем модальное окно
    const modal = document.getElementById('editProductModal');
    modal.style.display = 'block';
    
    // Прокручиваем к началу страницы, чтобы модальное окно было видно
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function closeEditModal() {
    document.getElementById('editProductModal').style.display = 'none';
    // document.body.style.overflow = 'auto'; // Убираем эту строку, так как мы не блокировали прокрутку
    currentEditingProduct = null;
}

function deleteProduct(productId) {
    if (confirm('Вы уверены, что хотите удалить этот товар?')) {
        products = products.filter(p => p.id !== productId);
        localStorage.setItem('products', JSON.stringify(products));
        scheduleAutoSync();
        loadProducts();
        loadAdminProducts();
        showNotification('Товар удален', 'success');
    }
}

function removeProductImage(productId, imageIndex) {
    const product = products.find(p => p.id === productId);
    if (product && product.images) {
        product.images.splice(imageIndex, 1);
        localStorage.setItem('products', JSON.stringify(products));
        scheduleAutoSync();
        editProduct(productId); // Обновляем форму
        showNotification('Изображение удалено', 'success');
    }
}

// Обработка формы редактирования товара
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editProductForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('Форма редактирования отправлена');
            
            const productId = parseInt(document.getElementById('editProductId').value);
            const product = products.find(p => p.id === productId);
            
            console.log('ID товара:', productId);
            console.log('Найденный товар:', product);
            
            if (product) {
                // Обновляем данные товара
                product.name = document.getElementById('editProductName').value;
                product.category = document.getElementById('editProductCategory').value;
                product.price = parseInt(document.getElementById('editProductPrice').value);
                product.description = document.getElementById('editProductDescription').value;
                
                console.log('Обновленные данные товара:', product);
                
                // Обработка новых изображений
                const newImagesInput = document.getElementById('editProductImages');
                const files = Array.from(newImagesInput.files);
                
                console.log('Обрабатываем новые изображения:', files.length);
                
                if (files.length > 0) {
                    let processedImages = 0;
                    
                    files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            // Сжимаем изображение перед сохранением
                            compressImage(file, 800, 600, 0.7).then(compressedImage => {
                                if (!product.images) product.images = [];
                                product.images.push(compressedImage);
                                processedImages++;
                                
                                console.log(`Изображение ${processedImages} из ${files.length} сжато и добавлено`);
                                
                                // Если обработали все изображения, сохраняем
                                if (processedImages === files.length) {
                                    console.log('Все изображения обработаны, сохраняем товар');
                                    saveEditedProduct();
                                }
                            });
                        } else {
                            processedImages++;
                            if (processedImages === files.length) {
                                saveEditedProduct();
                            }
                        }
                    });
                } else {
                    console.log('Нет новых изображений, сохраняем товар');
                    saveEditedProduct();
                }
            } else {
                console.error('Товар не найден!');
                showNotification('Ошибка: товар не найден', 'error');
            }
        });
    }
});

function saveEditedProduct() {
    console.log('saveEditedProduct вызвана');
    
    // Проверяем размер localStorage перед сохранением
    cleanupOldData();
    
    // Показываем анимацию сохранения
    showSavingAnimation();
    
    // Небольшая задержка для демонстрации анимации
    setTimeout(() => {
        try {
            // Сохраняем изменения
            const productsJson = JSON.stringify(products);
            localStorage.setItem('products', productsJson);
            scheduleAutoSync();
            
            console.log('Товар сохранен в localStorage');
            console.log('Размер localStorage:', checkLocalStorageSize(), 'символов');
            console.log('Обновленный товар:', currentEditingProduct);
            
            // Обновляем отображение
            loadProducts();
            loadAdminProducts();
            
            // Закрываем модальное окно
            closeEditModal();
            
            // Показываем уведомление об успехе
            showNotification('Товар успешно обновлен!', 'success');
        } catch (error) {
            console.error('Ошибка сохранения в localStorage:', error);
            
            if (error.name === 'QuotaExceededError') {
                // Если localStorage переполнен, удаляем старые товары
                console.log('localStorage переполнен, удаляем старые товары...');
                products = products.slice(-50); // Оставляем только последние 50 товаров
                localStorage.setItem('products', JSON.stringify(products));
                scheduleAutoSync();
                
                // Пробуем сохранить снова
                localStorage.setItem('products', JSON.stringify(products));
                scheduleAutoSync();
                
                // Обновляем отображение
                loadProducts();
                loadAdminProducts();
                
                // Закрываем модальное окно
                closeEditModal();
                
                showNotification('Товар обновлен (удалены старые товары из-за нехватки места)', 'success');
            } else {
                showNotification('Ошибка сохранения товара', 'error');
            }
        }
    }, 1500);
}

// Управление заказами
function updateOrderStatus(orderIndex, status) {
    const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
    if (contacts[orderIndex]) {
        contacts[orderIndex].status = status;
        localStorage.setItem('contacts', JSON.stringify(contacts));
        scheduleAutoSync();
        loadOrders();
        showNotification('Статус заказа обновлен', 'success');
    }
}

// Управление пользователями
function editUser(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;
    
    // Только отец может изменять роли пользователей
    const canChangeRole = currentUser && currentUser.email === 'father@metall.ru';
    
    const newName = prompt('Введите новое имя:', user.name);
    if (newName && newName.trim()) {
        const newPhone = prompt('Введите новый телефон:', user.phone);
        
        user.name = newName.trim();
        if (newPhone) user.phone = newPhone.trim();
        
        // Только отец может изменять роли
        if (canChangeRole && user.email !== 'father@metall.ru') {
            const newRole = confirm('Сделать администратором?') ? 'admin' : 'user';
            user.role = newRole;
        }
        
        localStorage.setItem('users', JSON.stringify(users));
        scheduleAutoSync();
        
        // Если редактируем текущего пользователя, обновляем его данные
        if (userId === currentUser.id) {
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateNavigation();
            loadProfile();
        }
        
        loadUsers();
        showNotification('Пользователь обновлен', 'success');
    }
}

function deleteUser(userId) {
    const userToDelete = users.find(u => u.id === userId);
    
    // Только отец может удалять пользователей
    if (!currentUser || currentUser.email !== 'father@metall.ru') {
        showNotification('Только главный администратор может удалять пользователей', 'error');
        return;
    }
    
    // Нельзя удалить самого себя
    if (userId === currentUser.id) {
        showNotification('Нельзя удалить самого себя', 'error');
        return;
    }
    
    // Нельзя удалить отца
    if (userToDelete && userToDelete.email === 'father@metall.ru') {
        showNotification('Нельзя удалить главного администратора', 'error');
        return;
    }
    
    if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
        users = users.filter(u => u.id !== userId);
        localStorage.setItem('users', JSON.stringify(users));
        scheduleAutoSync();
        loadUsers();
        showNotification('Пользователь удален', 'success');
    }
}

// Обработчики модальных окон
document.addEventListener('DOMContentLoaded', function() {
    // Закрытие модального окна редактирования товара
    const editModal = document.getElementById('editProductModal');
    if (editModal) {
        const editCloseBtn = editModal.querySelector('.close');
        if (editCloseBtn) {
            editCloseBtn.addEventListener('click', closeEditModal);
        }
        window.addEventListener('click', function(e) {
            if (e.target === editModal) {
                closeEditModal();
            }
        });
    }
    
    // Закрытие модального окна управления изображениями
    const imageManagerModal = document.getElementById('imageManagerModal');
    if (imageManagerModal) {
        const imageManagerCloseBtn = imageManagerModal.querySelector('.close');
        if (imageManagerCloseBtn) {
            imageManagerCloseBtn.addEventListener('click', closeImageManager);
        }
        window.addEventListener('click', function(e) {
            if (e.target === imageManagerModal) {
                closeImageManager();
            }
        });
    }
    
    // Предварительный просмотр изображений при редактировании
    const editImageInput = document.getElementById('editProductImages');
    const editImagePreview = document.getElementById('editImagePreview');
    
    if (editImageInput) {
        editImageInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            editImagePreview.innerHTML = '';
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        editImagePreview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
    }
});

// Управление изображениями
function openImageManager(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    const imagesGrid = document.getElementById('imagesGrid');
    imagesGrid.innerHTML = '';
    
    if (product.images && product.images.length > 0) {
        product.images.forEach((image, index) => {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.innerHTML = `
                <img src="${image}" alt="Изображение ${index + 1}">
                <button class="remove-image" onclick="removeProductImage(${productId}, ${index})">&times;</button>
            `;
            imagesGrid.appendChild(imageItem);
        });
    }
    
    document.getElementById('imageManagerModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeImageManager() {
    document.getElementById('imageManagerModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function addNewImages() {
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'image/*';
    
    input.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        const product = products.find(p => p.id === currentEditingProduct.id);
        
        if (product) {
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (!product.images) product.images = [];
                        product.images.push(e.target.result);
                        
                        // Обновляем отображение
                        openImageManager(product.id);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });
    
    input.click();
}

// Управление темами
function setupTheme() {
    // Загружаем сохраненную тему или устанавливаем темную по умолчанию
    const savedTheme = localStorage.getItem('theme') || 'dark';
    setTheme(savedTheme);
}

function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    
    // Обновляем иконку переключателя
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        const icon = themeToggle.querySelector('i');
        if (theme === 'light') {
            icon.className = 'fas fa-sun';
        } else {
            icon.className = 'fas fa-moon';
        }
    }
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    
    // Показываем уведомление
    showNotification(`Переключено на ${newTheme === 'light' ? 'светлую' : 'темную'} тему`, 'success');
}

// Функция для полной очистки товаров
function clearAllProducts() {
    if (confirm('Вы уверены, что хотите удалить ВСЕ товары? Это действие нельзя отменить!')) {
        products = [];
        localStorage.setItem('products', JSON.stringify(products));
        scheduleAutoSync();
        
        loadProducts();
        loadAdminProducts();
        showNotification('Все товары удалены', 'success');
    }
}

// Функция для проверки и удаления товаров по умолчанию
function removeDefaultProducts() {
    // Получаем текущие товары
    const storedProducts = localStorage.getItem('products');
    if (storedProducts) {
        const currentProducts = JSON.parse(storedProducts);
        
        // Фильтруем товары, оставляя только те, которые не являются товарами по умолчанию
        const defaultProductNames = [
            'Входная дверь',
            'Межкомнатная дверь',
            'Металлический забор',
            'Кованые ворота',
            'Кованая решетка',
            'Кованый забор',
            'Тестовый товар'
        ];
        
        const filteredProducts = currentProducts.filter(product => 
            !defaultProductNames.includes(product.name)
        );
        
        if (filteredProducts.length !== currentProducts.length) {
            products = filteredProducts;
            localStorage.setItem('products', JSON.stringify(products));
            scheduleAutoSync();
            loadProducts();
            loadAdminProducts();
            showNotification(`Удалено ${currentProducts.length - filteredProducts.length} товаров по умолчанию`, 'success');
        } else {
            showNotification('Товары по умолчанию не найдены', 'info');
        }
    } else {
        showNotification('Товары не найдены', 'info');
    }
}

// Функция для очистки localStorage
function clearLocalStorage() {
    if (confirm('Вы уверены, что хотите очистить ВСЕ данные localStorage? Это удалит все товары, контакты и настройки!')) {
        localStorage.clear();
        location.reload();
    }
}

// Функция для показа информации о localStorage
function showStorageInfo() {
    const size = checkLocalStorageSize();
    const sizeKB = (size / 1024).toFixed(2);
    const sizeMB = (size / (1024 * 1024)).toFixed(2);
    
    const products = JSON.parse(localStorage.getItem('products')) || [];
    const contacts = JSON.parse(localStorage.getItem('contacts')) || [];
    const users = JSON.parse(localStorage.getItem('users')) || [];
    
    const info = `
        Размер localStorage: ${sizeMB} MB (${sizeKB} KB)
        Товаров: ${products.length}
        Контактов: ${contacts.length}
        Пользователей: ${users.length}
    `;
    
    alert(info);
}

// Функция для сброса данных (для отладки)
function resetAppData() {
    if (confirm('Вы уверены, что хотите сбросить ВСЕ данные приложения? Это удалит все товары, пользователей и настройки!')) {
        localStorage.clear();
        location.reload();
    }
}

// Функция для тестирования добавления товара
function testAddProduct() {
    const testProduct = {
        id: Date.now(),
        name: 'Тестовый товар',
        category: 'doors',
        price: 10000,
        description: 'Это тестовый товар для проверки функциональности',
        images: [],
        dateAdded: new Date().toISOString()
    };
    
    console.log('Тестируем добавление товара:', testProduct);
    saveProduct(testProduct);
}

// Экспорт функций для глобального доступа
window.openModal = openModal;
window.closeModal = closeModal;
window.logout = logout;
window.editProfile = editProfile;
window.showMyOrders = showMyOrders;
window.showAddProductForm = showAddProductForm;
window.cancelAddProduct = cancelAddProduct;
window.editProduct = editProduct;
window.deleteProduct = deleteProduct;
window.closeEditModal = closeEditModal;
window.removeProductImage = removeProductImage;
window.updateOrderStatus = updateOrderStatus;
window.editUser = editUser;
window.deleteUser = deleteUser;
window.openImageManager = openImageManager;
window.closeImageManager = closeImageManager;
window.addNewImages = addNewImages;
window.toggleTheme = toggleTheme;
window.resetAppData = resetAppData;
window.clearAllProducts = clearAllProducts;
window.removeDefaultProducts = removeDefaultProducts;
window.syncDataToServer = syncDataToServer;
window.testAddProduct = testAddProduct;
window.showStorageInfo = showStorageInfo;
window.clearLocalStorage = clearLocalStorage;
  </script>
</body>
</html>
